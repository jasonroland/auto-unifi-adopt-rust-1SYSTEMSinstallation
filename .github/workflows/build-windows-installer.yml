name: Build Windows Installer

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install WiX Toolset
      run: |
        Invoke-WebRequest -Uri https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311.exe -OutFile wix311.exe
        .\wix311.exe /install /quiet /norestart
        echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install cargo-wix
      run: cargo install cargo-wix

    - name: Build Release
      run: cargo build --release --verbose

    - name: Build MSI Installer
      run: cargo wix --nocapture --verbose

    - name: Get version
      id: get_version
      shell: bash
      run: |
        VERSION=$(grep "^version" Cargo.toml | head -1 | cut -d '"' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Upload MSI as artifact
      uses: actions/upload-artifact@v4
      with:
        name: UniFi-Auto-Adopt-Installer-Windows-${{ steps.get_version.outputs.version }}
        path: target/wix/*.msi
        if-no-files-found: error

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: UniFi-Auto-Adopt-Portable-Windows-${{ steps.get_version.outputs.version }}
        path: target/release/auto-unifi-adopt-rust.exe
        if-no-files-found: error

    # Create release if this is a tag push
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          target/wix/*.msi
          target/release/auto-unifi-adopt-rust.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
